<div
  class="flex flex-col gap-6 p-6 shadow-lg rounded-lg bg-[var(--color-bg-light)] dark:bg-[var(--color-card-dark)] dark:text-[var(--color-text-dark)] max-w-4xl mx-auto border border-[var(--color-border-light)] dark:border-[var(--color-border-dark)]"
>
  <form [formGroup]="form" class="flex flex-col gap-6" (ngSubmit)="onSubmit()">
    <!-- Image + Basic Info -->
    <div class="flex flex-col sm:flex-row gap-6">
      <!-- Image Upload -->
      <div class="w-full sm:w-1/2">
        <label for="imageInput" class="block mb-2 font-semibold">
          Icon image <span class="text-red-600">*</span>
        </label>

        <label
          for="imageInput"
          class="block aspect-square w-full border-2 border-dashed rounded grid place-items-center text-[var(--color-border-light)] dark:text-[var(--color-border-dark)] cursor-pointer hover:border-[var(--color-accent-dark)] hover:text-[var(--color-accent-dark)] transition overflow-hidden"
        >
          @if (form.controls.image.value) {
            <img
              [src]="getImagePreview()"
              alt="Selected image"
              class="object-cover w-full h-full rounded"
            />
          } @else {
            @if (croppedImage) {
              <div class="flex items-center justify-center">
                <img
                  [src]="croppedImage"
                  alt="Selected image"
                  class="object-cover w-full h-full rounded"
                />
              </div>
            } @else {
              <div class="flex items-center justify-center w-full h-full"></div>
            }
          }
          @if (croppedImage) {
            <div class="flex items-center justify-center">
              <img
                [src]="croppedImage"
                alt="Selected image"
                class="object-cover w-full h-full rounded"
              />
            </div>
          } @else {
            <div class="flex items-center justify-center">
              <mat-icon
                class="!text-[150px] sm:!text-[330px] w-[150px] sm:w-[330px] h-[150px] sm:h-[330px] leading-none text-[var(--color-accent-dark)] dark:text-[var(--color-accent)]"
                fontIcon="add_a_photo"
              ></mat-icon>
            </div>
          }

          <ng-template #placeholderIcon>
            <div class="flex items-center justify-center">
              <mat-icon
                class="!text-[150px] sm:!text-[330px] w-[150px] sm:w-[330px] h-[150px] sm:h-[330px] leading-none text-[var(--color-accent-dark)] dark:text-[var(--color-accent)]"
                fontIcon="add_a_photo"
              ></mat-icon>
            </div>
          </ng-template>
        </label>

        <input
          id="imageInput"
          #fileInput
          type="file"
          accept=".webp,.png,.jpg,.jpeg"
          (change)="onFileSelected($event, fileInput)"
          class="hidden"
        />
      </div>

      <!-- Basic Info -->
      <div class="flex-1 mt-8 flex flex-col gap-2 w-full">
        <!-- Name -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label
            class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
          >
            Saint name
          </mat-label>

          <input matInput type="text" formControlName="name" />

          @let name = form.controls.name;

          @if ((name?.touched || name?.dirty) && name?.invalid) {
            <mat-error>
              @switch (true) {
                @case (name.errors?.["required"]) {
                  Saint name is required
                }

                @case (name.errors?.["onlyNumbers"]) {
                  Name cannot be only numbers
                }

                @case (name.errors?.["personName"]?.reason === "length") {
                  Name must be between
                  {{ name.errors?.["personName"]?.minLength }}
                  and
                  {{ name.errors?.["personName"]?.maxLength }}
                  characters
                }

                @case (
                  name.errors?.["personName"]?.reason === "invalidFormat"
                ) {
                  Only letters, spaces, apostrophes and hyphens are allowed
                }

                @case (name.errors?.["personName"]?.reason === "mustBeString") {
                  Invalid name format
                }
              }
            </mat-error>
          }
        </mat-form-field>

        <!-- Country -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label
            class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
          >
            Country
          </mat-label>
          <input matInput type="text" formControlName="country" />

          @let country = form.controls.country;

          @if ((country?.touched || country?.dirty) && country?.invalid) {
            <mat-error>
              @switch (true) {
                @case (country.errors?.["required"]) {
                  Country is required
                }
                @case (country.errors?.["minMaxLength"]?.reason === "min") {
                  Minimum
                  {{ country.errors?.["minMaxLength"]?.requiredLength }}
                  characters
                }
                @case (country.errors?.["minMaxLength"]?.reason === "max") {
                  Maximum
                  {{ country.errors?.["minMaxLength"]?.requiredLength }}
                  characters
                }
              }
            </mat-error>
          }

          @if (country.value | countryCode; as flagCode) {
            <ng-container matSuffix>
              <img
                [src]="'https://flagcdn.com/w20/' + flagCode + '.webp'"
                [alt]="country.value + ' flag'"
                class="w-5 h-5 mr-5 object-contain pointer-events-none"
              />
            </ng-container>
          }
        </mat-form-field>

        <!-- Century -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label
            class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
          >
            Century
          </mat-label>
          <mat-select formControlName="century">
            @for (item of centuries; track item) {
              <mat-option [value]="item">
                {{ item | roman }}
              </mat-option>
            }
          </mat-select>

          @let century = form.controls.century;

          @if ((century?.touched || century?.dirty) && century?.invalid) {
            <mat-error>
              @switch (true) {
                @case (century.errors?.["required"]) {
                  Century is required
                }
              }
            </mat-error>
          }
        </mat-form-field>

        <!-- Description -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label
            class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
          >
            Description
          </mat-label>
          <textarea
            matInput
            #descriptionTextarea
            formControlName="description"
            rows="1"
            class="resize-none overflow-hidden min-h-[40px]"
            (input)="autoResize($event)"
          ></textarea>

          @let description = form.controls.description;

          @if (
            (description?.touched || description?.dirty) && description?.invalid
          ) {
            <mat-error>
              @switch (true) {
                @case (description.errors?.["required"]) {
                  Description is required
                }
                @case (description.errors?.["minMaxLength"]?.reason === "min") {
                  Minimum
                  {{ description.errors?.["minMaxLength"]?.requiredLength }}
                  characters
                }
                @case (description.errors?.["minMaxLength"]?.reason === "max") {
                  Maximum
                  {{ description.errors?.["minMaxLength"]?.requiredLength }}
                  characters
                }
              }
            </mat-error>
          }
        </mat-form-field>

        <!-- Tags -->
        <div class="block">
          <mat-label
            class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
          >
            Tags
          </mat-label>

          <div class="flex flex-wrap items-center mt-2">
            <!-- Tags existentes -->
            @for (tag of currentTags; track $index) {
              <button
                type="button"
                (click)="removeTag(tag)"
                class="text-xs font-medium rounded-full bg-[var(--color-accent-dark)] text-white shadow-sm px-3 py-1 cursor-pointer transition hover:bg-[var(--color-primary)] focus:outline-none mr-2 mb-2"
                aria-label="Remove tag"
              >
                {{ tag }}
              </button>
            }

            <!-- Botão para abrir menu -->
            @if (currentTags.length < 5) {
              <button
                [matMenuTriggerFor]="tagsMenu"
                type="button"
                class="flex items-center justify-center w-6 h-6 rounded-full bg-[var(--color-border-dark)] text-[var(--color-text-dark)] hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] transition mr-2 mb-2"
                aria-label="Add tag"
              >
                +
              </button>
            }

            <!-- Menu com tags disponíveis -->
            <mat-menu
              #tagsMenu="matMenu"
              class="w-48 bg-[var(--color-card-light)] dark:bg-[var(--color-card-dark)]"
            >
              @for (tag of tagsList; track tag.id) {
                @if (!currentTags.includes(tag.name)) {
                  <button
                    mat-menu-item
                    (click)="addTag(tag.name)"
                    class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)]"
                  >
                    {{ tag.name }}
                  </button>
                }
              }
            </mat-menu>
          </div>
        </div>
      </div>
    </div>

    <!-- Markdown Editor -->
    <div>
      <label class="block flex flex-col">
        <span class="mb-5 font-semibold">
          Markdown <span class="text-red-600">*</span>
        </span>

        <div
          class="flex flex-col border rounded overflow-hidden h-[300px] dark:border-[var(--color-border-dark)] dark:bg-[var(--color-card-dark)]"
        >
          <!-- Toolbar -->
          <div
            class="flex gap-1 p-2 bg-gray-100 dark:bg-[var(--color-card-dark)] border-b dark:border-[var(--color-border-dark)] flex-wrap"
          >
            <button
              type="button"
              class="px-3 py-1 border rounded hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] dark:bg-[var(--color-card-dark)] dark:border-[var(--color-border-dark)] font-bold"
              (click)="insertMarkdown('**', '**')"
            >
              Bold
            </button>
            <button
              type="button"
              class="px-3 py-1 border rounded hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] dark:bg-[var(--color-card-dark)] dark:border-[var(--color-border-dark)] italic"
              (click)="insertMarkdown('*', '*')"
            >
              Italic
            </button>
            <button
              type="button"
              class="px-3 py-1 border rounded hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] dark:bg-[var(--color-card-dark)] dark:border-[var(--color-border-dark)]"
              (click)="insertMarkdown('## ', '')"
            >
              H2
            </button>
            <button
              type="button"
              class="px-3 py-1 border rounded hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] dark:bg-[var(--color-card-dark)] dark:border-[var(--color-border-dark)]"
              (click)="insertMarkdown('- ', '')"
            >
              List
            </button>
            <button
              type="button"
              class="px-3 py-1 border rounded hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] dark:bg-[var(--color-card-dark)] dark:border-[var(--color-border-dark)]"
              (click)="insertMarkdown('1. ', '')"
            >
              Ordered
            </button>
            <button
              type="button"
              class="px-3 py-1 border rounded hover:bg-[var(--color-accent-dark)] dark:hover:bg-[var(--color-primary)] dark:bg-[var(--color-card-dark)] dark:border-[var(--color-border-dark)]"
              (click)="insertMarkdown('---\n', '')"
            >
              Divider
            </button>
          </div>

          <!-- Editor + Preview -->
          <div class="flex flex-col sm:flex-row flex-1 overflow-hidden">
            <textarea
              formControlName="markdownContent"
              class="w-full sm:w-1/2 p-2 resize-none outline-none border-b sm:border-b-0 sm:border-r border-gray-300 dark:bg-[var(--color-bg-dark)] dark:border-[var(--color-border-dark)] dark:text-[var(--color-text-dark)]"
              placeholder="Type your markdown here..."
            ></textarea>

            <div
              class="w-full sm:w-1/2 p-2 bg-white dark:bg-[var(--color-card-dark)] overflow-auto markdown-body"
            >
              <markdown
                [data]="form.get('markdownContent')?.value"
                ngPreserveWhitespaces
              ></markdown>
            </div>
          </div>
        </div>
      </label>
    </div>

    <!-- Optional Fields -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label
          class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
        >
          Saint's title
        </mat-label>

        <input matInput type="text" formControlName="title" />

        @let title = form.controls.title;

        @if ((title?.touched || title?.dirty) && title?.invalid) {
          <mat-error>
            @switch (true) {
              @case (title.errors?.["minMaxLength"]?.reason === "min") {
                Minimum
                {{ title.errors?.["minMaxLength"]?.requiredLength }} characters
              }

              @case (title.errors?.["minMaxLength"]?.reason === "max") {
                Maximum
                {{ title.errors?.["minMaxLength"]?.requiredLength }} characters
              }
            }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label
          class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
        >
          Feast Day (optional)
        </mat-label>

        <input matInput type="text" formControlName="feastDay" mask="d0/M0" />

        @let feastDay = form.controls.feastDay;

        @if ((feastDay?.touched || feastDay?.dirty) && feastDay?.invalid) {
          <mat-error>
            @switch (true) {
              @case (feastDay.errors?.["feastDay"]?.reason === "format") {
                Use format DD/MM
              }

              @case (feastDay.errors?.["feastDay"]?.reason === "day") {
                Invalid day
              }

              @case (feastDay.errors?.["feastDay"]?.reason === "month") {
                Invalid month
              }
            }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label
          class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
        >
          Patron of
        </mat-label>

        <input matInput type="text" formControlName="patronOf" />

        @let patronOf = form.controls.patronOf;

        @if ((patronOf?.touched || patronOf?.dirty) && patronOf?.invalid) {
          <mat-error>
            @switch (true) {
              @case (patronOf.errors?.["minMaxLength"]?.reason === "min") {
                Minimum
                {{ patronOf.errors?.["minMaxLength"]?.requiredLength }}
                characters
              }

              @case (patronOf.errors?.["minMaxLength"]?.reason === "max") {
                Maximum
                {{ patronOf.errors?.["minMaxLength"]?.requiredLength }}
                characters
              }
            }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label
          class="text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]"
        >
          Religious Order (optional)
        </mat-label>

        <mat-select formControlName="religiousOrder">
          <mat-option [value]="null">None</mat-option>

          @for (order of religiousOrders; track order.id) {
            <mat-option [value]="order.id">
              {{ order.name }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Buttons -->
    <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-5 pt-5">
      <button
        mat-flat-button
        [routerLink]="['/admin/saints']"
        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded inline-flex items-center gap-2 w-full sm:w-auto"
        type="button"
      >
        <mat-icon class="text-white">undo</mat-icon> Cancel
      </button>
      <button
        mat-flat-button
        type="submit"
        [disabled]="form.invalid || imageLoading || isSubmitting"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded inline-flex items-center gap-2 w-full sm:w-auto"
      >
        <mat-icon class="text-white">{{
          isEditMode ? "edit" : "add"
        }}</mat-icon>
        {{ isEditMode ? "Update Saint" : "Create Saint" }}
      </button>
    </div>
  </form>
</div>
